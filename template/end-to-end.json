{"Parameters":{"UniqueId":{"Type":"String"},"KloudsUserIdentifier":{"Type":"String","Description":"A temporary ID used to refer back to the user that requested this in app, do not change."},"ConnectorPrincipalId":{"Type":"String","Description":"The principal that is allowed to assume this role, do not change."},"ConnectorExternalId":{"Type":"String","Description":"The external id used to match the connector when assuming this role, do not change."},"ConnectorEndpoint":{"Type":"String","Description":"The endpoint to send the role arn to when complete so kloud.io can assume this role, do not change."}},"Resources":{"Bucket":{"Type":"AWS::S3::Bucket","Properties":{"BucketName":{"Fn::Join":["",["klouds-cost-reports-",{"Ref":"UniqueId"}]]}}},"BucketPolicy":{"Type":"AWS::S3::BucketPolicy","Properties":{"Bucket":{"Ref":"Bucket"},"PolicyDocument":{"Version":"2012-10-17","Statement":[{"Effect":"Allow","Principal":{"Service":["billingreports.amazonaws.com"]},"Action":["s3:GetBucketAcl","s3:GetBucketPolicy"],"Resource":{"Fn::GetAtt":["Bucket","Arn"]}},{"Effect":"Allow","Principal":{"Service":["billingreports.amazonaws.com"]},"Action":["s3:PutObject"],"Resource":{"Fn::Join":["",[{"Fn::GetAtt":["Bucket","Arn"]},"/*"]]}}]}}},"Role":{"Type":"AWS::IAM::Role","Properties":{"RoleName":{"Fn::Join":["",["klouds-connector-",{"Ref":"UniqueId"}]]},"AssumeRolePolicyDocument":{"Statement":[{"Effect":"Allow","Principal":{"AWS":[{"Ref":"ConnectorPrincipalId"}]},"Action":"sts:AssumeRole","Condition":{"StringEquals":{"sts:ExternalId":{"Ref":"ConnectorExternalId"}}}}]},"ManagedPolicyArns":["arn:aws:iam::aws:policy/SecurityAudit"],"Policies":[{"PolicyName":"APIGatewayGETDomainNamePolicy","PolicyDocument":{"Version":"2012-10-17","Statement":[{"Action":"apigateway:GET","Effect":"Allow","Resource":["arn:aws:apigateway:*::/domainnames","arn:aws:apigateway:*::/domainnames/*","arn:aws:apigateway:*::/domainnames/*/basepathmappings","arn:aws:apigateway:*::/domainnames/*/basepathmappings/*"]}]}},{"PolicyName":"CostReportPolicy","PolicyDocument":{"Statement":[{"Action":["s3:ListBucket","s3:GetObject"],"Effect":"Allow","Resource":[{"Fn::GetAtt":["Bucket","Arn"]},{"Fn::Join":["",[{"Fn::GetAtt":["Bucket","Arn"]},"/*"]]}]}],"Version":"2012-10-17"}}]}},"ReportDefinition":{"Type":"AWS::CUR::ReportDefinition","Properties":{"Compression":"GZIP","Format":"textORcsv","RefreshClosedReports":false,"ReportName":"klouds-cost-reports-f7794f5772252e74","ReportVersioning":"OVERWRITE_REPORT","S3Bucket":{"Ref":"Bucket"},"S3Prefix":"costs","S3Region":{"Ref":"AWS::Region"},"TimeUnit":"DAILY","AdditionalSchemaElements":["RESOURCES"]}},"KloudsConnector":{"Type":"Custom::KloudsConnector","Properties":{"ServiceToken":{"Ref":"ConnectorEndpoint"},"RoleArn":{"Fn::GetAtt":["Role","Arn"]},"UserIdentifier":{"Ref":"KloudsUserIdentifier"},"ReportBucket":{"Ref":"Bucket"},"ReportBucketRegion":{"Ref":"AWS::Region"},"ReportPrefix":"costs","ReportName":{"Ref":"ReportDefinition"},"StackId":{"Ref":"AWS::StackId"},"Region":{"Ref":"AWS::Region"}}}},"Outputs":{"KloudsConnectorRoleArn":{"Description":"Role used by kloud.io to read resources","Value":{"Fn::GetAtt":["Role","Arn"]}}},"Description":"Generates Cost and Usage Reports and creates a cross-account IAM Role with READONLY access for use by klouds.io"}