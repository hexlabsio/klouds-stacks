{"Parameters":{"UniqueId":{"Type":"String"},"OrganizationalUnitIds":{"Type":"CommaDelimitedList","Description":"A comma seperated list of organizational unit ids, you may also provide the root id if you want all accounts"},"KloudsUserIdentifier":{"Type":"String","Description":"A temporary ID used to refer back to the user that requested this in app, do not change."},"ConnectorPrincipalId":{"Type":"String","Description":"The principal that is allowed to assume this role, do not change."},"ConnectorExternalId":{"Type":"String","Description":"The external id used to match the connector when assuming this role, do not change."},"ConnectorEndpoint":{"Type":"String","Description":"The endpoint to send the role arn to when complete so kloud.io can assume this role, do not change."}},"Resources":{"Bucket":{"Type":"AWS::S3::Bucket","DeletionPolicy":"Retain","Properties":{"BucketName":{"Fn::Join":["",["klouds-cost-reports-",{"Ref":"UniqueId"}]]}}},"BucketPolicy":{"Type":"AWS::S3::BucketPolicy","Properties":{"Bucket":{"Ref":"Bucket"},"PolicyDocument":{"Version":"2012-10-17","Statement":[{"Effect":"Allow","Principal":{"Service":["billingreports.amazonaws.com"]},"Action":["s3:GetBucketAcl","s3:GetBucketPolicy"],"Resource":{"Fn::GetAtt":["Bucket","Arn"]}},{"Effect":"Allow","Principal":{"Service":["billingreports.amazonaws.com"]},"Action":["s3:PutObject"],"Resource":{"Fn::Join":["",[{"Fn::GetAtt":["Bucket","Arn"]},"/*"]]}}]}}},"ReportDefinition":{"Type":"AWS::CUR::ReportDefinition","DependsOn":["Bucket","BucketPolicy"],"Properties":{"Compression":"GZIP","Format":"textORcsv","RefreshClosedReports":false,"ReportName":{"Fn::Join":["",["klouds-cost-reports-",{"Ref":"UniqueId"}]]},"ReportVersioning":"OVERWRITE_REPORT","S3Bucket":{"Ref":"Bucket"},"S3Prefix":"costs","S3Region":{"Ref":"AWS::Region"},"TimeUnit":"DAILY","AdditionalSchemaElements":["RESOURCES"]}},"Role":{"Type":"AWS::IAM::Role","Properties":{"RoleName":{"Fn::Join":["",["klouds-connector-",{"Ref":"UniqueId"}]]},"AssumeRolePolicyDocument":{"Statement":[{"Effect":"Allow","Principal":{"AWS":[{"Ref":"ConnectorPrincipalId"}]},"Action":"sts:AssumeRole","Condition":{"StringEquals":{"sts:ExternalId":{"Ref":"ConnectorExternalId"}}}}]},"ManagedPolicyArns":["arn:aws:iam::aws:policy/SecurityAudit"],"Policies":[{"PolicyName":"APIGatewayGETDomainNamePolicy","PolicyDocument":{"Version":"2012-10-17","Statement":[{"Action":"apigateway:GET","Effect":"Allow","Resource":["arn:aws:apigateway:*::/domainnames","arn:aws:apigateway:*::/domainnames/*","arn:aws:apigateway:*::/domainnames/*/basepathmappings","arn:aws:apigateway:*::/domainnames/*/basepathmappings/*"]}]}},{"PolicyName":"CostReportPolicy","PolicyDocument":{"Statement":[{"Action":["s3:ListBucket","s3:GetObject"],"Effect":"Allow","Resource":[{"Fn::GetAtt":["Bucket","Arn"]},{"Fn::Join":["",[{"Fn::GetAtt":["Bucket","Arn"]},"/*"]]}]}],"Version":"2012-10-17"}}]}},"KloudsConnector":{"Type":"Custom::KloudsConnector","Properties":{"ServiceToken":{"Ref":"ConnectorEndpoint"},"RoleArn":{"Fn::GetAtt":["Role","Arn"]},"UserIdentifier":{"Ref":"KloudsUserIdentifier"},"ReportBucket":{"Fn::GetAtt":["Bucket","Arn"]},"ReportBucketRegion":{"Ref":"AWS::Region"},"ReportPrefix":"costs","ReportName":{"Fn::Join":["",["klouds-cost-reports-",{"Ref":"UniqueId"}]]},"StackId":{"Ref":"AWS::StackId"},"Region":{"Ref":"AWS::Region"}}},"StackSet":{"Type":"AWS::CloudFormation::StackSet","DependsOn":["KloudsConnector"],"Properties":{"Description":"Deploys read-only IAM Roles in each account in order to connect to klouds.io","AutoDeployment":{"Enabled":true,"RetainStacksOnAccountRemoval":false},"PermissionModel":"SERVICE_MANAGED","StackSetName":{"Fn::Join":["",["klouds-connector",{"Ref":"UniqueId"}]]},"Capabilities":["CAPABILITY_NAMED_IAM"],"OperationPreferences":{"FailureTolerancePercentage":100,"MaxConcurrentPercentage":100},"TemplateURL":"https://klouds-user-template.s3.eu-west-1.amazonaws.com/end-to-end-for-stack-set.json","Parameters":[{"ParameterKey":"UniqueId","ParameterValue":{"Ref":"UniqueId"}},{"ParameterKey":"KloudsUserIdentifier","ParameterValue":{"Ref":"KloudsUserIdentifier"}},{"ParameterKey":"ConnectorPrincipalId","ParameterValue":{"Ref":"ConnectorPrincipalId"}},{"ParameterKey":"ConnectorExternalId","ParameterValue":{"Ref":"ConnectorExternalId"}},{"ParameterKey":"ConnectorEndpoint","ParameterValue":{"Ref":"ConnectorEndpoint"}}],"StackInstancesGroup":[{"Regions":["us-east-1"],"DeploymentTargets":{"OrganizationalUnitIds":{"Ref":"OrganizationalUnitIds"}}}]}}},"Description":"Generates Stack Sets across all your accounts to connect to klouds.io"}